const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./livechat-popup-DySf9K9o.js","./client-OfhJa1Pp.js","./agent-avatar-CN8Be1Dj.js","./use-compact-agents-VrJm5fj6.js","./helpdesk-channel-CQKSbeKg.js","./online-status-circle-QXiKm4xe.js","./HourglassEmpty-BpvqVftp.js","./reverse-conversation-messages-abBI68AY.js","./infinite-scroll-sentinel-sZcqy_uF.js","./isScrollable-BSEN4xi5.js","./use-widget-bootstrap-data-BlKRRco5.js","./customer-avatar-DNefi2od.js","./feed-attachments-54xris-A.js","./animating-messages-DuT2CR0j.js","./file-thumbnail-D9-TxWtC.js","./file-type-icon-Dok_AF4H.js","./formatted-bytes-CmuQhzYn.js","./pretty-bytes-bO14ePu9.js","./AttachFile-DK1KiGUi.js","./ticket-details-BWJm5pA-.js","./attribute-renderer-BAh3glGI.js","./ThumbDown-CmU9VZYm.js","./ThumbUp-B7v5mSGQ.js","./conversation-priority-tSI_39cp.js","./file-upload-provider-DTPBUrkd.js","./uploaded-file-DN6fXT4v.js","./with-selector-CDgEpx5P.js","./Edit-JNj6SFDx.js","./Email-BEay9knN.js","./ConfirmationNumber-8T4bmILd.js","./Download-ealU7kv_.js","./MoreHoriz-hMMIYAbm.js","./Schedule-BuWxyNlz.js","./FullscreenExit-BVexRmJS.js","./confirmation-dialog-BIOq1A-h.js","./download-file-from-url-hJ3EUwXO.js","./message-author-name-DihwIAPW.js","./unseen-messages-badge-BC9Ql5Uh.js","./websocket-updates-notifier-CaEDKM_o.js","./bullet-seprated-items-Dl11L_1z.js","./useInfiniteQuery-Dr3ouRcV.js","./infiniteQueryObserver-dCGK3uny.js","./messages-square-icon-CTmom_u4.js","./Send-CHhhtcWL.js","./custom-menu-BbwshV9x.js","./ArrowBack-DcV9hHRo.js","./skeleton-Cp2m1Uyc.js","./search-D3bB1V5N.js","./article-link-xsQ04UkN.js","./slugify-string-aubjgLQq.js","./article-page-feedback--zPIjw3k.js","./OpenInNew-Q67MT6Ae.js","./css-props-from-bg-config-CgypBlFP.js","./avatar-group-DoAzKV83.js","./attribute-input-renderer-BJ7XGaGf.js","./button-group-Cs5CuUiC.js","./date-picker-CUWok1XJ.js","./radio-Db_caP9D.js","./radio-group-DQLhD511.js","./select-Dsco87dL.js","./combobox-end-adornment-CaH5Sr_u.js","./checkbox-C4s6ROxp.js","./CheckBoxOutlineBlank-DQZJM1Yc.js","./use-customer-new-ticket-form-DC875_si.js","./accordtion-animation-BGCK95Hj.js","./get-default-values-for-form-with-attributes-htMbgWW2.js","./use-upload-attachments-D0EFLOL9.js","./use-captcha-CGFhx3Qc.js","./paperclip-DIi_RQSY.js","./progress-bar-iRLStr1h.js","./open-upload-window-CSDcieK1.js","./widget-navigation-DzRrm2db.js","./Chat-Ct1un6CP.js","./Help-DaN2Y9a4.js","./HelpOutline-BWHaeyMp.js","./Home--R_oEr6a.js","./widget-flags-DGIUgINI.js","./stream-BHqpFGMu.js","./useMutationState-V1q6F41O.js","./formatted-message-body-WNPn2fpJ.js","./emoji-picker-button-CQGpXygB.js","./tiptap-editor-context-BAgvnYfz.js","./check-circle-filled-DBwRd3aX.js","./Add-CN0r1QLK.js","./play-conversation-sound-DRUgHrdP.js","./ChatBubbleOutline-BMaPdsVG.js","./index.module-DxgU4A3H.js","./widget-active-campaign-CqMO-Oda.js","./campaign-renderer-DoUgJ45b.js"])))=>i.map(i=>d[i]);
var pt=Object.defineProperty;var ft=(e,t,s)=>t in e?pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var xe=(e,t,s)=>ft(e,typeof t!="symbol"?t+"":t,s);import{cL as we,cx as q,cM as be,cy as T,q as g,i as U,s as _,k as ce,Z as Be,l as gt,r as u,j as n,c3 as ht,B as ue,aP as vt,d as yt,T as C,bg as re,aU as O,aT as Le,bd as de,cN as xt,cs as wt,x as j,y as bt,h as G,c as Ke,b3 as qe,t as Ce,m as oe,aJ as Ct,aK as jt,p as N,H as St,by as B,u as E,a as Oe,am as Mt,an as At,ag as It,P as ze,ap as Tt,aj as L,aR as Re,as as Qe,a_ as me,E as Pt,cj as Nt,ck as _t,b$ as Et,av as Ft,bh as Dt,b4 as kt,ae as Wt,cJ as Ut,cK as je,cH as Bt,cI as Lt,b2 as P,C as le,D as Se,bM as Me,bc as $e,z as Ae,bG as Kt,cO as qt,cP as Ot,bJ as zt,cQ as Rt,cR as Qt,cS as $t,cT as Vt,cU as Ht,cV as Gt,cW as Jt}from"./client-OfhJa1Pp.js";import{e as Zt,s as Xt}from"./online-status-circle-QXiKm4xe.js";import{W as pe,a as H}from"./widget-flags-DGIUgINI.js";import{A as F,F as Ve,a as He,b as Yt,c as es,i as Ge}from"./feed-attachments-54xris-A.js";import{a as ts,b as Ie,u as ss,r as ns,M as as}from"./reverse-conversation-messages-abBI68AY.js";import{u as x,r as Je,F as is}from"./file-upload-provider-DTPBUrkd.js";import{A as rs}from"./attribute-renderer-BAh3glGI.js";import{A as os}from"./attribute-input-renderer-BJ7XGaGf.js";import{g as ls}from"./get-default-values-for-form-with-attributes-htMbgWW2.js";import{H as Ze}from"./HelpOutline-BWHaeyMp.js";import{E as cs,m as J}from"./stream-BHqpFGMu.js";import{a as K}from"./animating-messages-DuT2CR0j.js";import{g as Z,u as Xe}from"./use-widget-bootstrap-data-BlKRRco5.js";import{u as us}from"./useMutationState-V1q6F41O.js";import{F as ds}from"./formatted-message-body-WNPn2fpJ.js";import{u as ms}from"./useInfiniteQuery-Dr3ouRcV.js";import{E as ps}from"./emoji-picker-button-CQGpXygB.js";import{F as fs,a as gs}from"./file-thumbnail-D9-TxWtC.js";import{C as hs}from"./check-circle-filled-DBwRd3aX.js";import{A as vs}from"./Add-CN0r1QLK.js";import{o as Ye}from"./open-upload-window-CSDcieK1.js";import{A as ys}from"./AttachFile-DK1KiGUi.js";import{S as xs}from"./Send-CHhhtcWL.js";import{p as ws}from"./play-conversation-sound-DRUgHrdP.js";import{W as bs,u as et}from"./websocket-updates-notifier-CaEDKM_o.js";import{C as Cs}from"./ChatBubbleOutline-BMaPdsVG.js";import{h as I}from"./helpdesk-channel-CQKSbeKg.js";import{c as js}from"./index.module-DxgU4A3H.js";import"./HourglassEmpty-BpvqVftp.js";import"./formatted-bytes-CmuQhzYn.js";import"./pretty-bytes-bO14ePu9.js";import"./infinite-scroll-sentinel-sZcqy_uF.js";import"./isScrollable-BSEN4xi5.js";import"./agent-avatar-CN8Be1Dj.js";import"./use-compact-agents-VrJm5fj6.js";import"./customer-avatar-DNefi2od.js";import"./uploaded-file-DN6fXT4v.js";import"./with-selector-CDgEpx5P.js";import"./ThumbDown-CmU9VZYm.js";import"./ThumbUp-B7v5mSGQ.js";import"./button-group-Cs5CuUiC.js";import"./date-picker-CUWok1XJ.js";import"./radio-Db_caP9D.js";import"./radio-group-DQLhD511.js";import"./select-Dsco87dL.js";import"./combobox-end-adornment-CaH5Sr_u.js";import"./checkbox-C4s6ROxp.js";import"./CheckBoxOutlineBlank-DQZJM1Yc.js";import"./infiniteQueryObserver-dCGK3uny.js";import"./tiptap-editor-context-BAgvnYfz.js";import"./file-type-icon-Dok_AF4H.js";const v={customers:{invalidateKey:["users","customers"],get:()=>q({queryKey:["users","customers","widget"],queryFn:()=>T("lc/widget/customer")})},conversations:{invalidateKey:["conversations"],index:()=>we({queryKey:["conversations","widget"],queryFn:({pageParam:e})=>T("lc/widget/conversations",e?{cursor:e}:void 0),initialPageParam:null,getNextPageParam:be}),get:e=>q({enabled:!!e,queryKey:["conversations","widget",`${e}`],queryFn:async()=>{const t=await T(`lc/widget/conversations/${e}`);return st(t),t}}),messages:e=>we({staleTime:1/0,queryKey:["conversations","widget",`${e}`,"messages"],queryFn:({pageParam:t})=>T(`lc/widget/chats/${e}/messages`,t?{cursor:t}:void 0),initialPageParam:null,getNextPageParam:be})},articles:{hcData:()=>q({queryKey:["articles","widget","hcData"],queryFn:()=>T("lc/widget/help-center-data")}),homeArticleList:()=>q({queryKey:["articles","widget","homeArticleList"],queryFn:()=>T("lc/widget/home-article-list")})}};function tt(e,t){g.setQueryData(v.conversations.get(e).queryKey,t),st(t)}function st(e){g.setQueryData(v.conversations.messages(e.conversation.id).queryKey,t=>t?(t.pages[0]={pagination:e.items},{pages:t.pages,pageParams:t.pageParams}):{pages:[{pagination:e.items}],pageParams:[e.items.prev_cursor??null]})}function nt(e){return U({mutationFn:t=>ce.post(`lc/widget/chats/${e}/submit-form-data`,t).then(s=>s.data),onSuccess:()=>g.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>_(t)})}function X(){var e;return((e=Be(v.customers.get()).data)==null?void 0:e.user)??null}function fe(){return g.getQueryData(v.customers.get().queryKey).user}async function Ss(e){Ms(e)&&ce.post("lc/widget/customers/sync-external-data",e).then(t=>{g.setQueryData(v.customers.get().queryKey,t.data)})}function Ms(e){const t=fe();return!!Object.keys(e).some(s=>s==="email"?t.email!==e.email:s==="name"?t.name!==e.name:!0)}function ge({attributeIds:e,information:t,onSubmit:s,submitButtonLabel:a,isPending:i,disabled:o}){const r=Be(gt.attributes.normalizedList({attributeIds:e,for:"customer"})),l=u.useMemo(()=>e.map(c=>{var d;return(d=r.data)==null?void 0:d.attributes.find(m=>m.id===c)}).filter(c=>!!c),[r.data,e]);return r.isLoading?n.jsx(ht,{}):n.jsx("div",{className:"mb-12 px-16 pt-24",children:n.jsxs("div",{className:"relative rounded-panel border px-16 pb-16 pt-24",children:[n.jsx("div",{className:"absolute -top-20 left-0 right-0 mx-auto h-40 w-40 rounded-full bg-primary p-8 text-on-primary",children:n.jsx(Ze,{className:"block"})}),t&&n.jsx("div",{className:"mb-16 text-sm",children:t}),n.jsxs(As,{attributes:l,onSubmit:s,children:[l.map((c,d)=>n.jsx(os,{attribute:c,size:"sm"},`${c.name}:${d}`)),n.jsx(ue,{type:"submit",variant:"flat",color:"primary",className:"w-full",disabled:i||o,children:a})]})]})})}function As({attributes:e,children:t,onSubmit:s}){const a=Is(e);return n.jsx(vt,{form:a,className:"space-y-16",onSubmit:s,children:t})}function Is(e){const t=X(),s=ls(e);return t&&e.forEach(a=>{const i=a.key;i in t&&(s[a.key]=t[i])}),yt({defaultValues:s})}function Ts({message:e,disabled:t}){var a;const s=nt(e.conversation_id);return!((a=e.body.attributeIds)!=null&&a.length)||e.body.submitted?null:n.jsx(F,{uuid:e.uuid,children:n.jsx(ge,{attributeIds:e.body.attributeIds,information:e.body.message,onSubmit:i=>{s.mutate({type:"collectDetails",values:i})},submitButtonLabel:n.jsx(C,{message:"Submit"}),isPending:s.isPending,disabled:t})})}function Ps({align:e="left",avatar:t,color:s="chip",message:a}){return n.jsx(F,{uuid:a.uuid,children:n.jsx(Ve,{align:e,avatar:t,children:n.jsx(He,{color:s,children:n.jsxs("div",{className:"flex min-h-18 min-w-40 items-center justify-center gap-x-4",children:[n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite] rounded-full bg-text-muted"}),n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite_250ms] rounded-full bg-text-muted"}),n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite_500ms] rounded-full bg-text-muted"})]})})})})}function he(e){const t=e.author??"user",s=e.uuid||re();return{body:e.body,conversation_id:e.conversation_id??0,id:s,uuid:s,type:e.type??"message",created_at:e.created_at??Le().toAbsoluteString(),attachments:e.files??[],user:t==="user"&&O.user?{id:O.user.id,name:O.user.name,image:O.user.image}:null,author:e.author??"user",source:null,is_placeholder:!0,data:e.data}}const Ns=(e,t)=>Bs(Us(Fs(Es(_s(e,t)))));async function*_s(e,t){if(!e.body)throw Error("Response for endpoint had no body");const s=e.body.pipeThrough(new TextDecoderStream).pipeThrough(new cs).getReader();for(s.closed.then(()=>t.abort()),t.signal.addEventListener("abort",()=>s.cancel());!t.signal.aborted;){const{done:a,value:i}=await s.read();if(a){t.abort();break}if(!(!i||!i.event)){if(i.event==="delta")yield{event:i.event,data:JSON.parse(i.data)};else if(i.event==="message"||i.event==="debug"){const o={event:i.event,data:JSON.parse(i.data)};if(o.data.type==="endStream"){t.abort();break}yield o}}}}async function*Es(e){let t=performance.now(),s=null;const a=600;for await(const i of e){const o=performance.now(),r=o-t;yield i,i.event==="message"&&i.data.type==="typing"&&(!s||s.event!=="message"||s.data.type!=="typing")&&r<a&&await new Promise(l=>setTimeout(l,a-r)),t=o,s=i}}async function*Fs(e){let t="";for await(const s of e){if(s.event!=="delta"){yield s;continue}t+=s.data.delta,yield Ds(t)}}async function Ds(e){const t=await ks();return e=e.replaceAll("\\n",`
`),e=e.replace(/-$/,""),{event:"message",data:{type:"formattedHtml",content:t.render(Ws(e))}}}let D;async function ks(){if(!D){D=(await de(async()=>{const{default:t}=await import("./index-Blr6EMNg.js");return{default:t}},[],import.meta.url)).default();const e=D.renderer.rules.link_open||function(t,s,a,i,o){return o.renderToken(t,s,a)};D.renderer.rules.link_open=function(t,s,a,i,o){return t[s].attrSet("target","_blank"),e(t,s,a,i,o)}}return D}function Ws(e){let t=e;(e.match(/`/g)||[]).length%2!==0&&(t+="`"),(e.match(/```/g)||[]).length%2!==0&&(t+="\n```");const i=e.lastIndexOf("["),o=e.lastIndexOf("]("),r=e.lastIndexOf(")");i!==-1&&(o===-1||r<o)&&(o===-1&&(t+="]("),t+=")");const l=m=>(e.match(new RegExp(`\\${m}`,"g"))||[]).length;return l("*")%2!==0&&(t+="*"),l("_")%2!==0&&(t+="_"),t}async function*Us(e){let t=[];const s=/[a-zA-Z0-9À-ž'`]+$/,a=/^[a-zA-Z0-9À-ž'`]+/;for await(const i of e){if(i.event==="message"&&i.data.type==="endDeltaStream"){for(const r of t)yield r;t=[];continue}if(i.event!=="delta"){yield i;continue}t.push(i);let o=0;for(let r=1;r<t.length;r++){const l=s.test(t[r-1].data.delta),c=a.test(t[r].data.delta),d=l&&c,m=r-o>=5;d&&!m||(yield{event:"delta",data:{delta:t.slice(o,r).map(f=>f.data).join("")}},o=r)}t=t.slice(o)}for(const i of t)yield i}async function*Bs(e){const t=new EventTarget;let s=!1;const a=[],i=[],o=async()=>{const l=await e.next();l.done?s=!0:(a.push(l.value),i.push(performance.now()),o()),t.dispatchEvent(new Event("next"))};o();let r=performance.now();for(;!s||a.length>0;){const l=i.slice(-30),c=2e3,d=l.map((M,te,mt)=>M-mt[te-1]).slice(1).filter(M=>M>c).reduce((M,te)=>M+te,0),f=l.at(-1)-l[0]-d,p=Math.min(200,f/(l.length-1)),w=performance.now()-r;await Promise.race([Ls(Math.max(5,p-w)),Ks(t,"next")])||a.length!==0&&(r=performance.now(),yield a.shift())}}const Ls=e=>new Promise(t=>setTimeout(t,e)),Ks=(e,t)=>new Promise(s=>e.addEventListener(t,()=>s(!0),{once:!0}));function at(e,t){g.setQueryData(e,s=>{s||(s={pages:[xt],pageParams:[]});const a=s.pages,i=a[0].pagination.data,o=t(i),r=[...a];return r[0]={...a[0],pagination:{...a[0].pagination,data:[...o]}},{...s,pages:r}})}async function*Y(e,t,s){if(!e.ok||!(e!=null&&e.body))return wt(),null;let a=null;for await(const i of Ns(e,t)){if(i.event==="message"){if(i.data.type==="conversationCreated"&&(s=i.data.data.conversation.id),!s)continue;if(i.data.type==="typing"?qs(s):Te(s),i.data.type==="formattedHtml"&&(a=zs(a,s,i.data.content)),i.data.type==="messageCreated"){const o=i.data.message;ee(s,r=>{const l=r.filter(c=>c.type!=="streaming"&&c.type!=="typing"&&!("isPlaceholder"in c));return l.push(o),l})}yield i}i.event==="debug"&&console.log(i.data.type,i.data.data)}s&&Te(s)}function qs(e){let t=Os(e).find(s=>s.type==="typing");return t||(t=he({conversation_id:+e,body:"",author:"bot",type:"typing"}),K(t.uuid),ee(e,s=>[...s,t])),t}function Te(e){ee(e,t=>t.find(s=>s.type==="typing")?t.filter(s=>s.type!=="typing"):t)}function ee(e,t){at(v.conversations.messages(e).queryKey,t)}function Os(e){var t;return((t=g.getQueryData(v.conversations.messages(e).queryKey))==null?void 0:t.pages.flatMap(s=>s.pagination.data))??[]}function zs(e,t,s){if(e){e.body=s;const a=document.querySelector(`[data-message-id="${e.id}"] .streaming-message-body`);return a&&requestAnimationFrame(()=>{a.innerHTML=s}),e}else{const a=he({conversation_id:+t,body:s,author:"bot",type:"streaming"});return ee(t,i=>[...i,a]),a}}function it(){return j().sessionId}const Rs=400,Qs=16,S={open:{width:`${Rs+Qs*2}px`,height:"800px"},closed:{width:"94px",height:"94px"},articleMaximized:{width:"700px",height:"100%"}};let k=null;const W=bt()((e,t)=>({isMobile:Z().isMobile??!1,setIsMobile:s=>e({isMobile:s}),isAiAgentPreviewMode:!1,setIsAiAgentPreviewMode:s=>e({isAiAgentPreviewMode:s}),activeConversationId:null,setActiveConversationId:s=>e({activeConversationId:s}),widgetState:"closed",activeCampaign:null,widgetClosedAt:null,interactedWithWidget:!1,setWidgetState:(s,a)=>{const i=s==="closed",o=t().widgetState;if(!(o===s&&!a))if(e({activeCampaign:null,interactedWithWidget:!a}),i){k&&clearTimeout(k),e({widgetState:s,widgetClosedAt:a?null:performance.now()});const r=()=>{z({width:S[s].width,height:S[s].height,widgetState:s})};a?r():k=setTimeout(()=>r(),300)}else{k&&clearTimeout(k);const r=o==="articleMaximized"||s==="articleMaximized";z({width:S[s].width,height:S[s].height,widgetState:s},r),setTimeout(()=>{e({widgetState:s,activeCampaign:null,widgetClosedAt:null})})}},showCampaign:s=>{t().activeCampaign||(e({activeCampaign:s}),z({width:`${s.width+32}px`,height:`${s.height+80+16+28}px`,widgetState:t().widgetState}),$s(s,!1))},hideCampaign:()=>{e({activeCampaign:null}),z({width:S[t().widgetState].width,height:S[t().widgetState].height,widgetState:t().widgetState})}})),y=()=>W.getState();function z(e,t){window.parent.postMessage({source:"livechat-widget",type:"resize",width:e.width,height:e.height,widgetState:e.widgetState,shouldTransition:t},"*")}function $s(e,t){const{base_url:s}=j().settings;navigator.sendBeacon&&navigator.sendBeacon(`${s}/api/v1/lc/widget/campaigns/${e.id}/imp?_token=${j().csrf_token}`,JSON.stringify({isInteraction:t,sessionId:it()}))}const rt=["create-widget-chat"];function Vs(){const e=G();return U({mutationKey:rt,mutationFn:t=>{t.message&&K(t.message.uuid);const s=new AbortController,a=async i=>{y().setActiveConversationId(i.conversation.id),tt(i.conversation.id,i),await e(`/${y().isAiAgentPreviewMode?"ai-agent-preview-mode":"conversations"}/${i.conversation.id}`,{replace:!0})};return J("lc/widget/chats",Hs(t),s.signal).then(async i=>{for await(const o of Y(i,s))o.event==="message"&&o.data.type==="conversationCreated"&&a(o.data.data)})},onError:t=>_(t),onSuccess:()=>{g.invalidateQueries({queryKey:v.conversations.invalidateKey}),g.invalidateQueries({queryKey:v.customers.invalidateKey})}})}function Hs(e){var s;return{message:e.message?{...e.message,attachments:(s=e.message.attachments)==null?void 0:s.map(a=>a.id)}:void 0,preChatForm:e.preChatForm,flowId:e.flowId,startWithGreeting:e.startWithGreeting}}const ot=["submit-widget-chat-message"];function Gs(){return U({mutationKey:ot,mutationFn:({message:e,conversationId:t})=>{var a;const s=new AbortController;return J(`lc/widget/chats/${t}/messages`,{message:{...e,attachments:(a=e.attachments)==null?void 0:a.map(i=>i.id)}},s.signal).then(async i=>{const o=Y(i,s,t);for await(const r of o);})},onMutate:async e=>{await g.cancelQueries({queryKey:R(e.conversationId)});const t=g.getQueryData(R(e.conversationId));return K(e.message.uuid),at(R(e.conversationId),s=>[...s,he(e.message)]),{previousData:t}},onError:(e,t,s)=>{s!=null&&s.previousData&&g.setQueryData(R(t.conversationId),s.previousData),_(e)},onSuccess:()=>{g.invalidateQueries({queryKey:v.conversations.invalidateKey})}})}function R(e){return v.conversations.messages(e).queryKey}function ve(){const e=Vs(),t=Gs(),s=us({predicate:r=>r.options.mutationKey===rt||r.options.mutationKey===ot})>0,a=u.useCallback(r=>t.mutateAsync({...r,message:{...r.message,uuid:r.message.uuid||re()}},{onSuccess:(l,c)=>{y().setActiveConversationId(+c.conversationId)},onError:l=>_(l)}),[]),i=u.useCallback(r=>{var l;return e.mutateAsync({...r,message:r.message?{...r.message,uuid:r.message.uuid||re()}:void 0,flowId:r.startWithGreeting?(l=Z().newChatGreeting)==null?void 0:l.flow_id:null})},[]),o=u.useCallback(r=>r.conversationId?a(r):i({...r,startWithGreeting:!0}),[i,a]);return{submitMessage:a,createChat:i,sendMessageOrCreateChat:o,isPending:s}}function lt(){const{pathname:e}=Ke();return e.startsWith("/ai-agent-preview-mode")}function ct(e){const t=qe(),{sendMessageOrCreateChat:s,isPending:a}=ve(),i=Js(e.conversation_id),o=Zs(e.conversation_id),r=lt();return{handleButtonAction:c=>{var d;switch(c.actionType){case"openUrl":window.open(c.actionValue,"_blank");break;case"copyToClipboard":(d=navigator.clipboard)==null||d.writeText(c.actionValue),Ce(oe("Copied to clipboard!"));break;case"goToNode":i.mutate({nodeId:c.actionValue});break;case"setAttributes":o.mutate(c);break;case"openEmbed":if(r){Ce.danger(oe("Embed is not available in preview mode"));return}t("/embed",{state:{embedUrl:c.actionValue}});break;default:s({message:{body:c.actionValue||c.name},conversationId:e.conversation_id});break}},isPending:i.isPending||a}}function Js(e){return U({mutationFn:t=>{const s=new AbortController;return J(`conversations/${e}/flows/go-to-node`,t,s.signal).then(async a=>{for await(const i of Y(a,s,e));})},onSuccess:()=>g.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>_(t)})}function Zs(e){return U({mutationFn:t=>{const s=new AbortController;return J(`conversations/${e}/flows/set-attributes`,{message:t.actionValue,attributes:t.attributes},s.signal).then(async a=>{for await(const i of Y(a,s,e));})},onSuccess:()=>g.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>_(t)})}function Xs({message:e}){const t=u.useRef(null),[s,a]=u.useState(!0),[i,o]=u.useState(e.body.items.length<=1);return u.useEffect(()=>{const r=t.current;if(r){const l=()=>{a(r.scrollLeft===0),o(r.scrollLeft+r.clientWidth===r.scrollWidth)};return r.addEventListener("scroll",l),()=>{r.removeEventListener("scroll",l)}}},[]),n.jsxs(F,{className:"relative",uuid:e.uuid,children:[n.jsx("div",{className:"hidden-scrollbar mb-12 flex snap-x snap-mandatory items-start gap-14 overflow-x-auto scroll-smooth",ref:t,children:e.body.items.map((r,l)=>n.jsx(Ys,{item:r,message:e},l))}),n.jsxs("div",{className:"pointer-events-none absolute top-0 flex h-full w-full items-center",children:[n.jsx(Pe,{hidden:s,className:"mr-auto",onClick:()=>{t.current&&t.current.scrollBy({left:-240,behavior:"smooth"})},children:n.jsx(Ct,{})}),n.jsx(Pe,{hidden:i,className:"ml-auto",onClick:()=>{t.current&&t.current.scrollBy({left:240,behavior:"smooth"})},children:n.jsx(jt,{})})]})]})}function Ys({item:e,message:t}){const{handleButtonAction:s,isPending:a}=ct(t);return n.jsxs("div",{className:"w-240 flex-shrink-0 snap-center overflow-hidden rounded-panel border shadow-sm",children:[e.image&&n.jsx("img",{src:e.image,alt:"",className:"h-172 w-full rounded-t-panel object-cover"}),n.jsxs("div",{className:"px-20 pb-20 pt-16 text-sm",children:[n.jsx("div",{className:"line-clamp-2 whitespace-pre-wrap break-words font-semibold",children:e.title}),n.jsx("div",{className:"mt-8 line-clamp-4 whitespace-pre-wrap break-words",children:e.description})]}),e.buttons.map((i,o)=>n.jsx("div",{children:n.jsx("button",{disabled:a,className:"h-44 w-full overflow-hidden overflow-ellipsis whitespace-nowrap border-t px-20 text-sm font-semibold text-primary transition-button hover:bg-hover focus-visible:outline-primary-light disabled:bg-disabled disabled:text-disabled",onClick:()=>s(i),children:n.jsx(C,{message:i.name})})},o))]})}function Pe({children:e,onClick:t,hidden:s,className:a}){return n.jsx("button",{className:N("size-36 select-none rounded-full border bg shadow-[0_0_15px_0_rgba(0,0,0,.34)] outline-none transition-[opacity,color] hover:text-primary focus-visible:ring",s?"pointer-events-none opacity-0":"pointer-events-auto",a),onClick:()=>t(),children:e})}function en({children:e,className:t}){const s=u.Children.toArray(e);return n.jsx("div",{className:N("flex items-center gap-4",t),children:s.map((a,i)=>n.jsxs(u.Fragment,{children:[n.jsx("div",{children:a}),i<s.length-1?n.jsx("div",{children:"•"}):null]},i))})}const tn={policy:"conversationFileEntry",_xChatWidget:"true"};function sn({message:e,color:t,isLastInGroup:s=!0,isLast:a=!0,...i}){var r,l;const o=e.data??{};return n.jsxs(F,{uuid:e.uuid,children:[n.jsxs(Ve,{...i,className:N(s?"mb-12":"mb-4"),avatarInvisible:!s,footer:s?n.jsxs(en,{children:[e.author==="bot"&&n.jsx(es,{}),e.created_at&&n.jsx("time",{children:n.jsx(ts,{date:e.created_at})})]}):null,children:[e.body?n.jsx(He,{color:t,allowBreak:!0,children:n.jsx(ds,{isStreaming:e.type==="streaming",addParagraphSpacing:e.author==="bot",children:e.body})}):null,(r=e.attachments)!=null&&r.length?n.jsx(Yt,{align:i.align,onSelected:c=>{var d;(d=window.open(c.url,"_blank"))==null||d.focus()},attachments:e.attachments,color:t,previewSearchParams:tn}):null]}),!!((l=o.buttons)!=null&&l.length)&&a&&n.jsx(nn,{message:e,buttons:o.buttons})]})}function nn({buttons:e,message:t}){const{handleButtonAction:s,isPending:a}=ct(t);return n.jsx("div",{className:"mb-24 mt-12 flex flex-wrap justify-end gap-10",children:e==null?void 0:e.map((i,o)=>n.jsx(ue,{variant:"outline",color:"primary",className:"max-w-full overflow-hidden overflow-ellipsis shadow",fontWeight:"font-medium",disabled:a,onClick:()=>s(i),children:i.name},o))})}function ut({message:e,isLastInGroup:t=!0,isLast:s=!0}){return e.type==="event"?n.jsx(an,{event:e}):e.type==="submittedFormData"?n.jsx(rn,{message:e}):e.type==="collectDetailsForm"?n.jsx(Ts,{message:e,disabled:!s}):e.type==="cards"?n.jsx(Xs,{message:e}):e.type==="typing"?n.jsx(Ps,{message:e,avatar:n.jsx(Ie,{message:e,size:"sm"})}):e.type==="message"||e.type==="streaming"?n.jsx(sn,{messageId:e.id,isLastInGroup:t,isLast:s,avatar:e.author!=="user"?n.jsx(Ie,{message:e,size:"sm"}):void 0,message:e,align:e.author==="user"?"right":"left",color:e.author==="user"?"primary":"chip"}):null}function an({event:e}){const t=ss({message:e,variant:"customer"});return t?n.jsxs(F,{uuid:e.uuid,className:"mb-12 text-center text-xs text-muted",children:[n.jsx(C,{...t})," -"," ",n.jsx("time",{className:"inline-block whitespace-nowrap",children:n.jsx(St,{date:e.created_at,preset:"time"})})]}):null}function rn({message:e}){return n.jsxs(F,{uuid:e.uuid,className:"mx-16 my-24",children:[n.jsx("div",{className:"relative top-20 mx-auto h-40 w-40 rounded-full bg-primary p-8 text-on-primary",children:n.jsx(Ze,{className:"block"})}),n.jsx("div",{className:"space-y-14 rounded-panel border p-24 text-left text-sm",children:e.body.attributes.map(t=>n.jsxs("div",{children:[n.jsx("div",{className:"mb-2 text-muted",children:t.name}),n.jsx("div",{children:n.jsx(rs,{attribute:t})})]},t.key))})]})}function on({chatId:e}){var r,l,c,d;const{isInsideSettingsPreview:t}=B(),{chatWidget:s}=E(),a=(l=(r=s==null?void 0:s.forms)==null?void 0:r.postChat)==null?void 0:l.attributes,i=nt(e);if(!(a!=null&&a.length))return null;const o=m=>{t||i.mutate({type:"postChat",values:m})};return n.jsx("div",{className:"animated-chat-message",children:n.jsx(ge,{attributeIds:a,information:(d=(c=s==null?void 0:s.forms)==null?void 0:c.postChat)==null?void 0:d.information,onSubmit:o,submitButtonLabel:n.jsx(C,{message:"Submit"}),isPending:i.isPending})})}function Ne({onSubmit:e,isPending:t}){var o,r,l,c;const{isInsideSettingsPreview:s}=B(),{chatWidget:a}=E(),i=(r=(o=a==null?void 0:a.forms)==null?void 0:o.preChat)==null?void 0:r.attributes;return i!=null&&i.length?n.jsx("div",{className:"animated-chat-message",children:n.jsx(ge,{attributeIds:i,information:(c=(l=a==null?void 0:a.forms)==null?void 0:l.preChat)==null?void 0:c.information,onSubmit:d=>{s||!e||e(d)},submitButtonLabel:n.jsx(C,{message:"Start the chat"}),isPending:t??!1})}):null}function ln({disablePreChatForm:e}){var m;const{state:t}=Ke(),{isInsideSettingsPreview:s,settingsEditorParams:a}=B(),{conversationId:i}=Oe(),{chatWidget:o}=E(),r=(m=o==null?void 0:o.forms)==null?void 0:m.preChat,{isPending:l,createChat:c}=ve(),{newChatGreeting:d}=Xe();if(i&&!s)return null;if(s){if(a.form==="postChat")return n.jsx(on,{chatId:0});if(a.form==="preChat")return n.jsx(Ne,{})}else if(!e&&!(r!=null&&r.disabled)&&(r!=null&&r.attributes.length)){const f=!(t!=null&&t.messageBody);return n.jsx(Ne,{isPending:l,onSubmit:p=>{c({preChatForm:p,message:t!=null&&t.messageBody?{body:t.messageBody,attachments:[]}:void 0,startWithGreeting:f})}})}return n.jsx(cn,{})}function cn(){const{newChatGreeting:e}=Xe(),t=u.useRef(!1);return u.useMemo(()=>{t.current||(e==null||e.parts.forEach(s=>{K(s.uuid)}),t.current=!0)},[e==null?void 0:e.parts]),n.jsx(u.Fragment,{children:e==null?void 0:e.parts.map((s,a)=>n.jsx(ut,{message:s,...Ge(a,s,e.parts)},s.uuid))})}function un(e){return ms({...v.conversations.messages(e),select:ns,enabled:!!e})}function dn(e){var i,o;if(e==null)return!1;e.length===0&&(e=((i=Z().newChatGreeting)==null?void 0:i.parts)??[]);const t=e.at(-1),s=(t==null?void 0:t.type)==="collectDetailsForm",a=(t==null?void 0:t.type)==="message"&&!!((o=t.data)!=null&&o.preventTyping);return s||a}const mn={policy:"conversationFileEntry",_xChatWidget:"true"};function pn({onClose:e,onSelectFiles:t,maxUploads:s}){const a=x(c=>c.fileUploads),i=x(c=>c.completedUploadsCount),o=x(c=>c.activeUploadsCount),r=x(c=>c.uploadMultiple),l={uploadType:Re.conversationAttachments};return n.jsxs(Mt,{maxHeight:"max-h-400",shadow:"shadow-lg",children:[n.jsx(At,{showDivider:!0,titleTextSize:"text-sm",padding:"px-14 py-10",leftAdornment:o?n.jsx(ze,{isIndeterminate:!0,size:"sm"}):n.jsx(hs,{className:"text-positive"}),closeButtonIcon:n.jsx(It,{}),children:n.jsx(C,{message:":completed of :total uploaded",values:{completed:i,total:a.size}})}),n.jsxs(Tt,{padding:"p-14",className:"@container",children:[n.jsxs("div",{className:"mb-12 grid grid-cols-3 gap-10 @[400px]:grid-cols-4",children:[a.size<s&&n.jsx(L,{equalWidth:!0,color:"primary",variant:"outline",radius:"rounded-panel",size:null,className:"aspect-square",onClick:async()=>{const c=Je(l),d=await Ye({multiple:!0,types:c==null?void 0:c.allowedFileTypes});r(d,l)},children:n.jsx(vs,{})}),n.jsx(fs.Provider,{value:mn,children:[...a].map(([c,d])=>n.jsx(fn,{upload:d,uploadCount:a.size,onClose:e},c))})]}),n.jsx(ue,{variant:"flat",color:"primary",className:"w-full",onClick:()=>t(),disabled:!i||o>0,children:n.jsx(C,{message:"Select files"})})]})]})}function fn({upload:e,onClose:t,uploadCount:s}){const a=x(o=>o.abortUpload),i=x(o=>o.removeUpload);return n.jsxs("div",{className:"relative flex aspect-square min-h-0 flex-col rounded-panel border px-6 pb-4 pt-6",children:[n.jsx("div",{className:"m-4 flex min-h-0 flex-auto items-center justify-center overflow-hidden",children:e.entry?n.jsx(gs,{file:e.entry,className:"rounded-panel"}):n.jsx(gn,{file:e.file})}),n.jsx("div",{className:"mt-6 flex-shrink-0 overflow-hidden overflow-ellipsis whitespace-nowrap text-center text-xs",children:e.file.name}),n.jsx(L,{className:"absolute -right-8 -top-8",variant:"flat",radius:"rounded-full",color:"chip",size:"2xs",onClick:()=>{a(e.file.id),i(e.file.id),s<2&&t()},children:n.jsx(Qe,{})})]})}function gn({file:e}){const t=x(r=>r.fileUploads.get(e.id)),s=(t==null?void 0:t.percentage)||0,a=t==null?void 0:t.status,i=t==null?void 0:t.errorMessage;let o;if(a==="failed"){const r=i||oe("This file could not be uploaded");o=n.jsx(me,{variant:"danger",label:n.jsx(Nt,{value:r}),children:n.jsx(Pt,{className:"text-danger",size:"md"})})}else a==="aborted"?o=n.jsx(_t,{className:"text-warning",size:"md"}):a==="completed"?o=n.jsx(Et,{size:"md",className:"text-positive"}):o=n.jsx(ze,{"aria-label":"Upload progress",size:"sm",value:s,isIndeterminate:s<1||s>99});return n.jsx("div",{className:"flex flex-auto items-center justify-center",children:o})}function hn({className:e,size:t,iconSize:s,maxUploads:a=6,disabled:i,inputContainerRef:o}){const[r,l]=u.useState(!1),c=x(p=>p.completedUploadsCount),d=x(p=>p.fileUploads.size>0),m=x(p=>p.uploadMultiple),f={uploadType:Re.conversationAttachments};return n.jsx(u.Fragment,{children:n.jsxs(Ft,{type:"popover",mobileType:"popover",isOpen:r,onOpenChange:p=>l(p),usePortal:!1,placement:"top",offset:14,handleTriggerClick:!1,triggerRef:o,children:[n.jsx(me,{label:n.jsx(C,{message:"Upload a file"}),children:n.jsx(L,{badge:c?n.jsx(Dt,{top:"-top-2",right:"right-2",children:c}):void 0,onClick:async p=>{if(p.stopPropagation(),r)l(!1);else{if(!d){const w=Je(f),h=await Ye({multiple:!0,types:w==null?void 0:w.allowedFileTypes});m(h.slice(0,a-1),f)}l(!0)}},disabled:i,size:t,className:e,iconSize:s,children:n.jsx(ys,{className:"rotate-[30deg]"})})}),n.jsx(pn,{maxUploads:a,onClose:()=>l(!1),onSelectFiles:()=>{l(!1)}})]})})}function vn({isPending:e,onSubmit:t}){const{hasPermission:s}=kt(),a=!s("files.create"),{isInsideSettingsPreview:i}=B(),{chatWidget:o}=E(),r=x(h=>h.getCompletedFileEntries),l=x(h=>h.clearInactive),c=u.useRef(null),d=u.useRef(null),[m,f]=u.useState(""),{trans:p}=Wt(),w=async()=>{e||(i?(f(""),l()):(t({body:m,attachments:r()}),f(""),l()))};return n.jsx("form",{ref:d,className:"m-0 flex-shrink-0",onSubmit:h=>{h.stopPropagation(),h.preventDefault(),w()},children:n.jsxs("div",{ref:c,className:"relative overflow-hidden rounded-[24px] bg-elevated shadow-[rgba(0,0,0,0.2)_0px_0px_4px] transition-shadow focus-within:ring dark:shadow-[rgba(255,255,255,0.2)_0px_0px_4px]",children:[n.jsxs("div",{className:"relative max-h-[6em] min-h-48 min-w-0 flex-auto",children:[n.jsx("textarea",{required:!0,className:"compact-scrollbar absolute inset-0 max-h-inherit resize-none border-none bg-transparent py-14 pl-14 pr-96 text-sm text outline-none",value:m,rows:1,onChange:h=>f(h.target.value),placeholder:p({message:(o==null?void 0:o.inputPlaceholder)??"Enter your message here..."}),onKeyDown:h=>{h.key==="Enter"&&(h.preventDefault(),w())}}),n.jsx("div",{className:"invisible max-h-inherit whitespace-pre-line py-14 pl-14 pr-96 text-sm",children:m})]}),n.jsxs("div",{className:"absolute bottom-0 right-0 top-0 flex items-end px-6 pb-6",children:[n.jsx(ps,{onSelected:h=>f(m+h),className:"text-muted",size:"sm"}),!a&&n.jsx(hn,{inputContainerRef:c,className:"text-muted",size:"sm",disabled:i}),n.jsx(me,{label:n.jsx(C,{message:"Submit"}),children:n.jsx(L,{disabled:e||i,type:"submit",size:"sm",color:"primary",children:n.jsx(xs,{})})})]})]})})}function yn(){const e=u.useRef(!1),t=qe();return u.useEffect(()=>(e.current||(pe.setHeadersForPreviewMode(),y().setIsAiAgentPreviewMode(!0),e.current=!0,H.postLoaded(window.parent)),H.listen(window,{onConversationReset:()=>t("/ai-agent-preview-mode",{replace:!0})})),[]),n.jsx("div",{className:"h-full bg text-main scheme-dark",children:n.jsxs(Ut,{children:[n.jsx(je,{path:"ai-agent-preview-mode",element:n.jsx(_e,{})}),n.jsx(je,{path:"ai-agent-preview-mode/:conversationId",element:n.jsx(_e,{})})]})})}function _e(){var a;const{conversationId:e}=Oe(),t=un(e),s=((a=t.data)==null?void 0:a.items)??[];return u.useEffect(()=>(H.postConversationIdChanged(window.parent,e??null),()=>{H.postConversationIdChanged(window.parent,null)}),[e]),n.jsxs("div",{className:"flex h-full flex-col",children:[n.jsx(Bt,{}),n.jsx(Lt,{}),n.jsx("div",{className:N("compact-scrollbar flex-auto overflow-y-auto px-20 py-20"),children:n.jsxs(as,{className:"w-full",query:t,children:[n.jsx(ln,{disablePreChatForm:!0}),s.map((i,o)=>n.jsx(ut,{message:i,...Ge(o,i,s)},i.uuid))]})}),n.jsx("div",{className:"mt-20 flex-shrink-0 px-20 pb-16",children:n.jsx(is,{children:dn(s)?null:n.jsx(xn,{conversationId:e})})})]})}function xn({conversationId:e}){const{createChat:t,submitMessage:s,isPending:a}=ve();return n.jsx(vn,{isPending:a,onSubmit:i=>{e?s({message:i,conversationId:e}):t({message:i,startWithGreeting:!0})}})}function b(e,t,s){switch(e){case P.eq:return t===s;case P.ne:return t!==s;case P.contains:return Ee(t,s);case P.notContains:return!Ee(t,s);case P.gt:return t>s;case P.lt:return t<s;default:return!1}}function Ee(e,t){return typeof e!="string"||typeof t!="string"?!1:e.toLowerCase().includes(t.toLowerCase())}function Fe(e,t){var s,a,i,o,r,l,c,d,m,f;switch(t.name){case"isReturningVisitor":return!!((s=e.user)!=null&&s.is_returning);case"isFirstTimeVisitor":return!((a=e.user)!=null&&a.is_returning);case"timeOnCurrentPage":return b(t.operator,Math.floor((performance.now()-e.currentUrlLoadedAt)/1e3),+t.value);case"timeOnAllPages":return b(t.operator,Math.floor((performance.now()-e.sessionStartedAt)/1e3),+t.value);case"currentPageUrl":return b(t.operator,e.currentUrl,t.value);case"anyVisitedPageUrl":return e.sessionVisits.some(M=>b(t.operator,M.url,t.value));case"neverInteractedWithWidget":return!e.interactedWithWidget;case"numberOfViewedPages":return b(t.operator,e.sessionVisits.length,+t.value);case"userCountry":return b(t.operator,(i=e.user)==null?void 0:i.country,t.value);case"userBrowser":return b(t.operator,(o=e.user)==null?void 0:o.browser,t.value);case"userPlatform":return b(t.operator,(r=e.user)==null?void 0:r.platform,t.value);case"userDevice":return b(t.operator,(l=e.user)==null?void 0:l.device,t.value);case"signedUp":const p=t.value,w=((d=(c=e.user)==null?void 0:c.attributes)==null?void 0:d.signed_up_at)??((m=e.user)==null?void 0:m.created_at);if(!w)return!1;const h=Math.floor((Date.now()-new Date(w).getTime())/864e5);return b(t.operator,h,p);case"attribute":return!t.valueKey||!e.user?!1:b(t.operator,(f=e.user.attributes)==null?void 0:f[t.valueKey],t.value)}}const De=[];let se=!1,$={currentUrl:"",currentUrlLoadedAt:0,sessionStartedAt:0,sessionVisits:[],user:null,interactedWithWidget:!1};async function V(e){if(e&&($={...$,...e}),$.interactedWithWidget=y().interactedWithWidget,se||y().widgetState!=="closed"||wn())return;se=!0;const s=(await Cn()).find(a=>{if(bn(a))return!0});s&&s.enabled&&!De.includes(s.id)&&(De.push(s.id),y().showCampaign(s)),se=!1}function wn(){const e=y().widgetClosedAt;return e!=null&&performance.now()-e<15e3}function bn(e){const t=[],s=[];for(const r of e.conditions)r.match_type==="all"?t.push(r):s.push(r);const a={...$,user:fe()},i=t.every(r=>Fe(a,r)),o=s.length?s.some(r=>Fe(a,r)):!0;return i&&o}let Q=null;async function Cn(){return Q||(Q=ce.get("lc/widget/campaigns").then(e=>e.data.pagination.data),Q)}let A=null,ne=null;const ke=[];function jn(){window.addEventListener("message",async e=>{e.data.source==="livechat-loader"&&e.data.type==="navigate"&&(ke.push({url:e.data.url,time:e.data.time}),ne&&clearTimeout(ne),A&&(ae(A,"ended"),A=null),ne=setTimeout(async()=>{A=await Sn(e.data)},5e3),V({currentUrl:e.data.url,currentUrlLoadedAt:e.data.time,sessionStartedAt:e.data.initialLoadTime,sessionVisits:ke}))}),document.addEventListener("visibilitychange",()=>{A&&(document.visibilityState==="hidden"?ae(A,"ended"):ae(A,"active"))})}async function Sn({url:e,title:t,referer:s}){return(await(await fetch(`${j().settings.base_url}/api/v1/lc/widget/visits`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":j().csrf_token,[pe.keys.headers.widget]:"true"},body:JSON.stringify({url:e,title:t,referer:s,session_id:it(),started_at:Le().toAbsoluteString()})})).json()).visit}function ae(e,t){const{base_url:s}=j().settings;navigator.sendBeacon&&navigator.sendBeacon(`${s}/api/v1/lc/widget/visits/${e.id}/change-status?_token=${j().csrf_token}&_xChatWidget=true`,JSON.stringify({status:t}))}let ie=null;function dt(){const{isInsideSettingsPreview:e}=B();if(ie==null){const t=new URLSearchParams(window.location.search).get("inline")==="true";ie={isAppearanceEditor:e,isDirect:t,isInline:e||t}}return ie}class Mn extends bs{constructor(){super(...arguments);xe(this,"isCountInWidgetTitle",!1)}init(){this.initNotifier()}playSound(s){(s==="incomingChat"||s==="message")&&ws(s,"widget")}appIsVisible(){return document.visibilityState==="visible"&&y().widgetState!=="closed"}conversationBelongsToUser(s){return s.user_id===fe().id}addCountToTitle(s){this.isCountInWidgetTitle=!0,this.notifyLoaderOfChanges("addCountToTitle",s)}isCountInTitle(){return this.isCountInWidgetTitle}removeCountFromTitle(){this.isCountInWidgetTitle=!1,this.notifyLoaderOfChanges("removeCountFromTitle")}notifyLoaderOfChanges(s,a){window.parent.postMessage({source:"livechat-widget",type:"unseenChats",action:s,count:a},"*")}}const ye=new Mn;let We=!1;function An(){var t;if(We)return;const e=Z();(t=e.activeConversationData)!=null&&t.conversation&&(y().setActiveConversationId(e.activeConversationData.conversation.id),tt(e.activeConversationData.conversation.id,e.activeConversationData)),g.setQueryData(v.customers.get().queryKey,{user:e.user}),ye.init(),We=!0}function In(){const{chatWidget:e}=E(),t=u.useMemo(()=>{var i,o;const s=(i=e==null?void 0:e.spacing)!=null&&i.bottom?parseInt(e.spacing.bottom):16,a=(o=e==null?void 0:e.spacing)!=null&&o.side?parseInt(e.spacing.side):16;return{bottom:Math.min(s,16),side:Math.min(a,16)}},[e==null?void 0:e.spacing]);return{paddingBottom:t.bottom,paddingSide:t.side,paddingLeft:(e==null?void 0:e.position)==="left"?t.side:void 0,paddingRight:(e==null?void 0:e.position)==="right"?t.side:void 0,marginLeft:(e==null?void 0:e.position)==="right"?"auto":void 0,marginRight:(e==null?void 0:e.position)==="left"?"auto":void 0}}function Tn(){const{isInline:e,isDirect:t}=dt(),s=W(r=>r.widgetState!=="closed"),a=G(),i=W(r=>r.isMobile),o=In();return t||i&&s?null:n.jsxs("div",{style:o,className:"relative mt-auto flex-shrink-0 pt-4",children:[n.jsx(Nn,{}),n.jsx(L,{display:"block",onClick:()=>{if(e)return;const r=et.getState().unseenConversations;r.length>0&&a(`/conversations/${r[0]}`),y().setWidgetState(y().widgetState==="closed"?"open":"closed")},variant:"raised",color:"primary",radius:"rounded-full",size:"xl",iconSize:"lg",shadow:"chat-toggle-shadow",children:n.jsx(le,{initial:!1,mode:"wait",children:s&&!e?u.createElement(Se.div,{...Me,key:"close-icon"},n.jsx(Qe,{size:"lg"})):u.createElement(Se.div,{...Me,key:"chat-icon"},n.jsx(Pn,{}))})})]})}function Pn(){const{chatWidget:e}=E();return e!=null&&e.launcherIcon?n.jsx("img",{src:e.launcherIcon,alt:"",className:"m-auto h-34 w-34 object-cover"}):n.jsx(Cs,{size:"lg"})}function Nn(){const e=W(s=>s.widgetState);return!et(s=>s.unseenConversations.length||s.conversationsWithUnseenMessages.length)||e!=="closed"?null:n.jsx("div",{className:"absolute right-14 top-8 h-14 w-14 rounded-full bg-danger"})}function _n(){const e=G(),t=X(),s=$e("/conversations/:conversationId"),a=s!=null&&s.params.conversationId?+s.params.conversationId:null,i=js(()=>{g.invalidateQueries({queryKey:v.conversations.invalidateKey})},500);En([I.events.conversations.created,I.events.conversations.updated,I.events.conversations.newMessage],(t==null?void 0:t.id)??null,o=>{ye.handleEvent(o),o.messageUuid&&K(o.messageUuid);const r=y().activeConversationId;r&&o.conversations.some(l=>l.id===r&&l.status_category<=Ae.closed)&&y().setActiveConversationId(null),o.event!==I.events.conversations.newMessage&&i(),o.event===I.events.conversations.newMessage&&g.invalidateQueries({queryKey:v.conversations.messages(o.conversations[0].id).queryKey,refetchType:"all"}),o.event===I.events.conversations.created&&o.conversations.some(l=>l.status_category>=Ae.open)&&o.conversations.some(l=>l.type==="chat")&&a!==o.conversations[0].id&&e(`/conversations/${o.conversations[0].id}`)})}function En(e,t,s){const a=u.useRef(s);a.current=s,u.useEffect(()=>{if(t)return Zt().listen({channel:I.name,events:e,type:"presence",callback:i=>{i.conversations.every(o=>o.user_id===t)&&a.current(i)}})},[t])}const Fn=u.lazy(()=>de(()=>import("./livechat-popup-DySf9K9o.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86]),import.meta.url)),Dn=u.lazy(()=>de(()=>import("./widget-active-campaign-CqMO-Oda.js"),__vite__mapDeps([87,1,88,52,3,4,5,6,2,43,76,10,12,13,14,15,16,17,18,7,8,9,11,24,25,26,20,21,22,54,55,56,57,58,59,60,61,62,65,74,77,78,79,40,41,80,81,82,83,70,84,38,85,86]),import.meta.url));let Ue=!1;function kn(){An();const e=X();return lt()?n.jsx(yn,{}):e!=null&&e.banned_at?null:n.jsx(Wn,{})}function Wn(){const{isInline:e,isAppearanceEditor:t}=dt(),s=X(),a=W(c=>c.widgetState),[i,o]=u.useState(!1),{selectThemeTemporarily:r}=Kt(),l=G();return u.useEffect(()=>{if(s&&!Ue){if(Xt("/lc/widget/broadcasting/auth"),pe.setHeadersForLiveMode(),Ue=!0,s.banned_at){o(!0);return}Bn(j().settings.chatWidget),jn(),setInterval(()=>V(),1e3),window.addEventListener("message",async p=>{p.data.source==="livechat-loader"&&(p.data.type==="setTheme"?r(p.data.themeId):p.data.type==="setUserData"?(Ss(p.data.userData),V()):p.data.type==="isMobile"&&y().setIsMobile(p.data.isMobile))}),o(!0),!e&&!t&&setTimeout(()=>V());let c=e;const m=new URL(window.location.toString()).searchParams.get("conversationId"),f=y().activeConversationId;m&&m===`${f}`?(c=!0,l(`/conversations/${m}`)):!t&&e&&l(f?`/conversations/${f}`:"/conversations/new"),y().setWidgetState(c?"open":"closed",!0)}},[s,i,e,r,l,t]),_n(),n.jsxs(u.Fragment,{children:[!t&&n.jsx(Un,{}),n.jsx("div",{className:N("h-full w-full",e&&"flex items-center justify-center",e&&a==="closed"&&"hidden"),children:n.jsxs("div",{className:N("isolate",i?"flex h-full max-h-full w-full flex-col":"hidden",e&&"mx-auto"),style:e?{width:S[a].width,height:S[a].height}:void 0,children:[n.jsx(le,{initial:!1,children:(a!=="closed"||e)&&n.jsx(u.Suspense,{children:n.jsx(Fn,{})})}),!e&&n.jsx(le,{children:n.jsx(u.Suspense,{children:n.jsx(Dn,{})})}),n.jsx(Tn,{})]})})]})}function Un(){const e=$e("conversations/*"),t=!!e,s=e==null?void 0:e.params["*"];return u.useEffect(()=>{ye.setPageStatus({activeConversationId:s?+s:null,isInboxOpen:t})},[t,s]),null}function Bn(e){window.parent.postMessage({source:"livechat-widget",type:"bootstrap",widgetConfig:e},"*")}const Ln=(j().settings.html_base_uri??"/")+"lc/widget",Kn=n.jsx(Qt,{basename:Ln,children:n.jsx($t,{client:g,children:n.jsxs(Vt,{children:[n.jsx(Ht,{}),n.jsx(Gt,{features:Jt,children:n.jsx(kn,{})})]})})});qt("absolute");Ot.createRoot(zt).render(Kn);Rt();export{ln as W,W as a,In as b,X as c,v as d,un as e,dt as f,ut as g,on as h,ve as i,vn as j,$s as l,dn as s,Vs as u,y as w};
