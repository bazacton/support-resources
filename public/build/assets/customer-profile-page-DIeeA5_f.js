import{h as $,cl as pe,l as j,j as e,T as i,q as P,i as D,s as W,k as T,ae as ge,r as x,al as A,am as E,ap as L,ac as Z,P as C,ad as je,p as fe,aQ as ve,bf as be,d as J,t as X,m as B,aj as Y,aP as ee,a$ as Se,J as ye,I as Ie,F as se,ay as Ne,az as N,b7 as _,f as ae,aG as te,aX as M,av as R,B as f,Z as Pe,an as re,aq as ie,L as De,ao as Te,aR as we,S as Fe}from"./client-OfhJa1Pp.js";import{G as ze}from"./generic-conversations-table-DDCPonwk.js";import{D as Ce}from"./data-table-pagination-footer-CEEx1VtI.js";import{u as _e}from"./use-datatable-search-params-CQGreY35.js";import{u as Ae}from"./use-datatable-query-BQ-GXlzU.js";import{u as Q,I as Ee,a as ne,o as oe}from"./custom-menu-BbwshV9x.js";import{M as Le}from"./messages-square-icon-CTmom_u4.js";import{A as Be}from"./attribute-input-renderer-BJ7XGaGf.js";import{g as Me}from"./get-default-values-for-form-with-attributes-htMbgWW2.js";import{T as Re,P as Qe,D as Oe,a as g,E as ke}from"./envato-purchase-list-JwWt_J1A.js";import{a as V}from"./use-is-module-installed-FCoToztC.js";import{D as qe,b as Ue}from"./crupdate-resource-layout-D52z_ZDE.js";import{D as Ve}from"./datatable-page-with-header-layout-B1YkbSHJ.js";import{u as Ge}from"./use-tags-BR3jky3Z.js";import{P as G}from"./PushPin-Df_CN_Sp.js";import{d as He,e as H,D as Ke,h as $e,G as We}from"./main-CqFMqK8-.js";import{A as Ze,a as Je}from"./accordion-DWEV-mKU.js";import{C as le}from"./chip-list-CkGaRoaT.js";import{F as z}from"./select-Dsco87dL.js";import{A as de}from"./Add-CN0r1QLK.js";import{T as me}from"./toggle-right-sidebar-icon-DXM314Tt.js";import{F as Xe}from"./normalized-model-field-COxh0lBC.js";import{u as Ye}from"./use-is-customer-online-Dt4E9Uxw.js";import{u as ce,C as es}from"./customer-avatar-DNefi2od.js";import{U as ss}from"./update-user-page-actions-D1Ivswsr.js";import{u as as}from"./update-account-details-UjZzNeIq.js";import{D as ts}from"./dashboard-sidenav-B5THGxpt.js";import{I as rs}from"./image-selector-Bwr5VwEQ.js";import{F as is}from"./file-upload-provider-DTPBUrkd.js";import{O as ns}from"./online-status-circle-QXiKm4xe.js";import{B as os,a as K}from"./breadcrumb-DMWJORWM.js";import{S as ls}from"./Send-CHhhtcWL.js";import"./attribute-renderer-BAh3glGI.js";import"./ThumbDown-CmU9VZYm.js";import"./ThumbUp-B7v5mSGQ.js";import"./conversation-priority-tSI_39cp.js";import"./get-status-color-HuOrk9nw.js";import"./unseen-messages-badge-BC9Ql5Uh.js";import"./websocket-updates-notifier-CaEDKM_o.js";import"./helpdesk-channel-CQKSbeKg.js";import"./ConfirmationNumber-8T4bmILd.js";import"./SupervisorAccount-k9OnPB-d.js";import"./table-BifRiqkr.js";import"./checkbox-C4s6ROxp.js";import"./CheckBoxOutlineBlank-DQZJM1Yc.js";import"./skeleton-Cp2m1Uyc.js";import"./ArrowDownward-mN9PlQJw.js";import"./useEffectEvent-DQn3o5L0.js";import"./is-ctrl-key-pressed-BWsUhNJl.js";import"./useGlobalListeners-CeWFSHKo.js";import"./button-group-Cs5CuUiC.js";import"./date-picker-CUWok1XJ.js";import"./radio-Db_caP9D.js";import"./radio-group-DQLhD511.js";import"./formatted-duration-6c7isaot.js";import"./use-sync-envato-purchases-BudvWHKl.js";import"./external-link-DbBk1ItZ.js";import"./use-toggle-dashboard-left-sidebar-CnzMOFB9.js";import"./toggle-left-sidebar-icon-Dq5ZwqwZ.js";import"./accordtion-animation-BGCK95Hj.js";import"./combobox-end-adornment-CaH5Sr_u.js";import"./Edit-JNj6SFDx.js";import"./use-unban-users-TBy06zKy.js";import"./paginated-resources-BrzANtLm.js";import"./confirmation-dialog-BIOq1A-h.js";import"./use-active-upload-CCDRf1Tl.js";import"./open-upload-window-CSDcieK1.js";import"./uploaded-file-DN6fXT4v.js";import"./shallow-BSWIanyL.js";import"./AddAPhoto-eWqbbo4Z.js";import"./progress-bar-iRLStr1h.js";import"./file-input-config-DrcTpI3-.js";import"./pretty-bytes-bO14ePu9.js";import"./with-selector-CDgEpx5P.js";import"./HourglassEmpty-BpvqVftp.js";import"./ChevronRight-T5gg5A4x.js";import"./MoreHoriz-hMMIYAbm.js";const ds=["status","summary","assignee_id","updated_at","created_at"];function ms(){const s=$(),{userId:t}=Q(["userId"]),{mergeIntoSearchParams:r,sortDescriptor:n,searchParams:a}=_e(pe),o=Ae(j.customers.indexConversations(t,a));return o.isEmpty?e.jsx(cs,{}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsx(ze,{data:o.items,activeColumns:ds,sortDescriptor:n,onSortChange:r,onRowAction:d=>{s(`/dashboard/conversations/${d.id}`)}})}),e.jsx(Ce,{hideIfOnlyOnePage:!0,onPageChange:d=>r({page:d}),query:o})]})}function cs(){return e.jsx("div",{className:"mt-124 flex w-full items-center justify-center",children:e.jsx(Ee,{size:"sm",image:e.jsx(Le,{size:"xl"}),imageMargin:"mb-12",imageHeight:"h-auto",title:e.jsx(i,{message:"Customer has not started any conversation yet"})})})}function us(s){const{taggableType:t,taggableId:r,type:n,notType:a}=s,o=["tags","taggable",t,`${r}`];return n!=null&&o.push(n),a!=null&&o.push(a),o}function ue({taggableType:s,taggableIds:t}){return Promise.allSettled(t.map(r=>P.invalidateQueries({queryKey:us({taggableType:s,taggableId:r})})))}function xs(){return D({mutationFn:s=>hs(s),onSuccess:async(s,t)=>{ue(t)},onError:s=>W(s)})}function hs(s){return T.post("taggable/attach-tag",s).then(t=>t.data)}function ps(){return D({mutationFn:s=>gs(s),onSuccess:(s,t)=>{ue(t)},onError:s=>W(s)})}function gs(s){return T.post("taggable/detach-tag",s).then(t=>t.data)}function js({attachedTags:s,tagType:t,notTagType:r,taggableType:n,taggableIds:a,userId:o,isLoading:d,onChange:m,onSelected:v}){const{trans:S}=ge(),[u,c]=x.useState(""),{close:I}=A(),{data:h,isPlaceholderData:O,isLoading:xe}=Ge({type:t,notType:r,query:u,userId:o}),k=ps(),w=xs(),{tags:q,attachedTagIds:he}=x.useMemo(()=>{const l=(h==null?void 0:h.pagination.data)||[],b=s||[],y=b.map(F=>F.id),U=l.filter(F=>!y.includes(F.id));return U.unshift(...b),{tags:U,attachedTagIds:y}},[s,h]);return e.jsx(E,{children:e.jsxs(L,{padding:"p-8",children:[e.jsx("form",{children:e.jsx(Z,{placeholder:S({message:"Type tag name..."}),inputBorder:"border-b",inputRadius:"rounded-none",inputRing:"ring-0",inputShadow:"shadow-none",startAdornment:e.jsx(je,{}),value:u,onChange:l=>c(l.target.value),endAdornment:O&&e.jsx(C,{isIndeterminate:!0,size:"w-24 h-24"})})}),e.jsxs(He,{className:"compact-scrollbar h-320 overflow-y-auto stable-scrollbar",children:[q.map(l=>{const b=he.includes(l.id),y=w.isPending||k.isPending||d;return e.jsx(H,{isDisabled:y,onSelected:()=>{if(v){v(l.name),I();return}!a||!n||(b?k.mutate({tagId:l.id,taggableIds:a,taggableType:n},{onSuccess:()=>m==null?void 0:m(l.id)}):w.mutate({taggableType:n,taggableIds:a,tagName:l.name,userId:o,tagType:t},{onSuccess:()=>m==null?void 0:m(l.id)}))},className:fe(b&&(y?"text-primary-light":"text-primary")),startIcon:e.jsx(G,{size:"xs"}),endSection:b?e.jsx(ve,{size:"sm",className:"block text-primary"}):e.jsx("div",{className:"h-20 w-20"}),children:l.name},l.id)}),!O&&!(h!=null&&h.pagination.data.length)&&u&&e.jsx(H,{startIcon:e.jsx(G,{size:"xs"}),onSelected:()=>{if(v){v(u),I();return}!a||!n||w.mutate({taggableType:n,taggableIds:a,tagName:u,userId:o,tagType:t},{onSuccess:l=>{c(""),m==null||m(l.tag.id)}})},children:e.jsx(i,{message:'Create tag ":name"',values:{name:u}})}),h&&!q.length&&!u&&e.jsx("li",{className:"text-center text-muted",children:e.jsx(i,{message:"No tags found"})}),xe&&e.jsx("li",{className:"flex justify-center",children:e.jsx(C,{isIndeterminate:!0,size:"w-24 h24"})})]})]})})}function fs(){const{userId:s}=Q(["userId"]),t=V("envato"),r=V("livechat"),a=ne(j.customers.get(s)).data.user,{rightSidenavStatus:o,setRightSidenavStatus:d}=x.useContext(Ke),[m,v]=be("dash.customer.details",[0,1,2,3,4,5]),S=J({defaultValues:{name:a.name,timezone:a.timezone,country:a.country?a.country.toLowerCase():"",language:a.language??"",tags:a.tags??[],notes:a.notes??"",emails:a.emails??[],attributes:Me(a.attributes)}}),u=D({mutationFn:c=>T.put(`helpdesk/customers/${s}`,c),onSuccess:(c,I)=>{S.reset(I),P.invalidateQueries(j.customers.get(s)),X(B("Customer details updated"))},onError:c=>oe(c,S)});return e.jsxs(x.Fragment,{children:[e.jsx(Ve,{rightContent:e.jsx(Y,{className:"ml-auto",size:"xs",onClick:()=>d(o==="open"?"closed":"open"),children:e.jsx(me,{})}),children:e.jsx(i,{message:"Details"})}),e.jsx("div",{className:"compact-scrollbar flex-auto overflow-y-auto stable-scrollbar",children:e.jsxs(ee,{form:S,onSubmit:c=>u.mutate(c),children:[e.jsxs(Ze,{expandedValues:m??[],onExpandedChange:c=>v(c),mode:"multiple",variant:"minimal",children:[e.jsx(p,{label:e.jsx(i,{message:"General"}),children:e.jsx(vs,{user:a})}),e.jsx(p,{label:e.jsx(i,{message:"Emails"}),children:e.jsx(bs,{user:a})}),e.jsx(p,{label:e.jsx(i,{message:"Tags"}),children:e.jsx(ys,{})}),t&&e.jsx(p,{label:e.jsx(i,{message:"Envato purchase codes"}),children:e.jsx(Ns,{user:a})}),e.jsx(p,{label:e.jsx(i,{message:"Notes"}),children:e.jsx(Is,{})}),a.session&&e.jsx(p,{label:e.jsx(i,{message:"Technology"}),children:e.jsx(Re,{session:a.session})}),r&&e.jsx(p,{label:e.jsx(i,{message:"Visited pages"}),children:e.jsx(Qe,{userId:a.id})}),e.jsx(p,{label:e.jsx(i,{message:"Searches"}),children:e.jsx(Ps,{user:a})})]}),e.jsx(qe,{isLoading:u.isPending})]})})]})}function vs({user:s}){const t=Se(),r=ye("en"),n=Ie("en");return e.jsxs(Oe,{children:[e.jsx(g,{label:e.jsx(i,{message:"Name"}),children:e.jsx(se,{name:"name",size:"xs",inputBorder:"border border-divider-lighter"})}),e.jsx(g,{label:e.jsx(i,{message:"Timezone"}),children:e.jsx(z,{name:"timezone",size:"xs",inputBorder:"border border-divider-lighter",showSearchField:!0,floatingWidth:"auto",children:Object.entries(t).map(([a,o])=>e.jsx(Ne,{label:a,children:o.map(d=>e.jsx(N,{value:d,children:d},d))},a))})}),e.jsx(g,{label:e.jsx(i,{message:"Country"}),children:e.jsx(z,{name:"country",size:"xs",inputBorder:"border border-divider-lighter",showSearchField:!0,floatingWidth:"auto",children:r.map(a=>e.jsx(N,{value:a.code,children:a.name},a.code))})}),e.jsx(g,{label:e.jsx(i,{message:"Language"}),children:e.jsx(z,{name:"language",size:"xs",inputBorder:"border border-divider-lighter",children:n.map(a=>e.jsx(N,{value:a.code,children:a.name},a.code))})}),e.jsx(g,{label:e.jsx(i,{message:"Last login"}),children:s.last_active_at?e.jsx(_,{date:s.last_active_at}):"-"}),e.jsx(g,{label:e.jsx(i,{message:"Created"}),children:s.created_at?e.jsx(_,{date:s.created_at}):"-"}),s.attributes.map(a=>e.jsx(g,{label:e.jsx(i,{message:a.name}),children:e.jsx(Be,{attribute:a,formPrefix:"attributes",hideLabel:!0,inputBorder:"border border-divider-lighter",size:"xs",className:"text-sm",preferSelects:!0})},a.id))]})}function bs({user:s}){const t=ae(),r=te({name:"emails"}),n=e.jsxs(R,{type:"modal",onClose:a=>{a&&!r.includes(a)&&t.setValue("emails",[...r,a],{shouldDirty:!0})},children:[e.jsx(f,{variant:"flat",color:"chip",size:"xs",className:"max-h-26",startIcon:e.jsx(de,{}),children:e.jsx(i,{message:"Add email"})}),e.jsx(Ss,{})]});return e.jsxs(x.Fragment,{children:[s.email&&e.jsx("div",{className:"mb-12 text-xs text-muted",children:e.jsx(i,{message:"Primary: :email",values:{email:s.email}})}),e.jsx(le,{size:"sm",radius:"rounded-button",startButton:n,children:r.map(a=>e.jsx(M,{onRemove:()=>t.setValue("emails",r.filter(o=>o!==a),{shouldDirty:!0}),children:a},a))})]})}function Ss(){const[s,t]=x.useState(""),r=x.useId(),{close:n}=A();return e.jsxs(E,{children:[e.jsx(re,{children:e.jsx(i,{message:"Add email"})}),e.jsx(L,{children:e.jsx("form",{id:r,onSubmit:a=>{a.stopPropagation(),a.preventDefault(),n(s)},children:e.jsx(Z,{label:e.jsx(i,{message:"Email"}),type:"email",required:!0,autoFocus:!0,value:s,onChange:a=>t(a.target.value)})})}),e.jsxs(ie,{children:[e.jsx(f,{children:e.jsx(i,{message:"Cancel"})}),e.jsx(f,{type:"submit",variant:"flat",color:"primary",form:r,children:e.jsx(i,{message:"Add"})})]})]})}function ys(){const s=ae(),t=te({name:"tags"});return e.jsx(le,{size:"sm",radius:"rounded-button",startButton:e.jsxs(R,{type:"modal",children:[e.jsx(f,{variant:"flat",color:"chip",size:"xs",className:"max-h-26",startIcon:e.jsx(de,{}),children:e.jsx(i,{message:"Add tag"})}),e.jsx(js,{onSelected:r=>{t.includes(r)||s.setValue("tags",[...t,r],{shouldDirty:!0})}})]}),children:t.map(r=>e.jsx(M,{onRemove:()=>s.setValue("tags",t.filter(n=>n!==r),{shouldDirty:!0}),children:r},r))})}function Is(){return e.jsx(se,{inputElementType:"textarea",rows:3,name:"notes",size:"xs",inputBorder:"border border-divider-lighter"})}function Ns({user:s}){var t;return e.jsx(x.Fragment,{children:(t=s.envato_purchase_codes)!=null&&t.length?e.jsx(ke,{userId:s.id,initialData:s.envato_purchase_codes}):e.jsx("div",{className:"text-sm text-muted",children:e.jsx(i,{message:"No envato purchases yet"})})})}function Ps({user:s}){const{data:t}=Pe(j.customers.indexSearches(s.id,{perPage:"8"}));return t?t.pagination.data.length?e.jsx("div",{className:"space-y-14",children:t.pagination.data.map(r=>e.jsxs("div",{children:[e.jsx("div",{className:"overflow-hidden overflow-ellipsis whitespace-nowrap text-sm",children:r.term}),e.jsx("div",{className:"text-[13px] text-muted",children:e.jsx("div",{className:"min-w-0 overflow-hidden overflow-ellipsis whitespace-nowrap",children:e.jsx(_,{date:r.last_seen,style:"long"})})})]},r.id))}):e.jsx("div",{className:"font-italic text-xs text-muted",children:e.jsx(i,{message:"No recent searches"})}):e.jsx("div",{className:"flex justify-center",children:e.jsx(C,{isIndeterminate:!0,size:"xs"})})}function p(s){return e.jsx(Je,{...s,buttonPadding:"py-12 pl-24 pr-2r",bodyPadding:"px-24 pb-16 pt-4",labelClassName:"font-semibold",className:"border-b",children:s.children})}function Ds({userId:s,userName:t}){const{close:r,formId:n}=A(),a=J({defaultValues:{mergee_id:s}}),o=Ts(a),d=a.watch("user_id");return e.jsxs(E,{children:[e.jsx(re,{children:e.jsx(i,{message:"Merge ':name' into another user",values:{name:t}})}),e.jsx(L,{children:e.jsx(ee,{id:n,form:a,onSubmit:m=>{o.mutate(m,{onSuccess:()=>r()})},children:e.jsx(Xe,{name:"user_id",endpoint:"normalized-models/user",label:e.jsx(i,{message:"User to merge into"}),placeholder:B("Select user"),description:e.jsx(i,{message:"':name' will be deleted and all data belonging to them will be merged into selected user.",values:{name:t}})})})}),e.jsxs(ie,{children:[e.jsx(f,{onClick:()=>r(),children:e.jsx(i,{message:"Cancel"})}),e.jsx(f,{type:"submit",variant:"flat",color:"primary",form:n,disabled:!d||o.isPending,children:e.jsx(i,{message:"Merge"})})]})]})}function Ts(s){const t=$();return D({mutationFn:r=>T.post("helpdesk/customers/merge",r).then(n=>n.data),onSuccess:async(r,n)=>{await Promise.allSettled([P.invalidateQueries({queryKey:j.customers.invalidateKey}),P.invalidateQueries({queryKey:j.conversations.invalidateKey})]),X(B("Users merged")),t(`../${n.user_id}`)},onError:r=>oe(r,s)})}function st(){const{userId:s}=Q(["userId"]),{data:t}=ne(j.customers.get(s)),r=ce(t.user);return e.jsxs(e.Fragment,{children:[e.jsx($e,{children:r}),e.jsx(ts,{position:"right",size:"xl",className:"dashboard-rounded-panel flex-col lg:ml-8",children:e.jsx(fs,{})}),e.jsxs("div",{className:"dashboard-rounded-panel dashboard-grid-content flex flex-col",children:[e.jsx(Ue,{endActions:e.jsxs(e.Fragment,{children:[e.jsx(f,{elementType:De,to:`/dashboard/conversations/new?customer_id=${t.user.id}`,variant:"outline",startIcon:e.jsx(ls,{size:"xs"}),className:"max-md:hidden",children:e.jsx(i,{message:"Start conversation"})}),e.jsx(ws,{user:t.user}),e.jsx(Fs,{})]}),children:e.jsxs(os,{size:"xl",children:[e.jsx(K,{to:"..",relative:"path",children:e.jsx(i,{message:"Customers"})}),e.jsx(K,{children:e.jsx(i,{message:"Edit"})})]})}),e.jsx("div",{className:"flex-auto overflow-y-auto",children:e.jsxs("div",{className:"p-20 lg:p-44",children:[e.jsx(zs,{user:t.user}),e.jsx("div",{className:"mt-24",children:e.jsx(ms,{})})]})})]})]})}function ws({user:s}){const[t,r]=x.useState(!1),n=ce(s);return e.jsxs(e.Fragment,{children:[e.jsx(ss,{user:s,children:e.jsx(N,{value:"merge",onSelected:()=>r(!0),children:e.jsx(i,{message:"Merge into another user"})},"merge")}),e.jsx(R,{type:"modal",isOpen:t,onOpenChange:r,children:e.jsx(Ds,{userId:s.id,userName:n})})]})}function Fs(){const{toggleRightSidebar:s,rightSidebarOpen:t}=We();return t?null:e.jsx(Y,{onClick:()=>s(),size:"xs",children:e.jsx(me,{})})}function zs({user:s}){const t=s.banned_at!==null,r=Ye(s.id)??s.was_active_recently;return e.jsxs("div",{className:"mx-auto mb-44 flex-shrink-0",children:[e.jsxs("div",{className:"flex gap-32",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Cs,{user:s}),e.jsx("div",{className:"absolute right-0 top-2",children:e.jsx(ns,{isOnline:r,size:"md",color:r?"bg-positive":"bg-danger"})})]}),e.jsxs("div",{children:[e.jsx(M,{size:"xs",className:"mb-6",children:e.jsx(i,{message:"Customers"})}),e.jsx("h1",{className:"text-2xl font-semibold",children:e.jsx(es,{user:s})}),e.jsx("div",{className:"mt-4 text-sm text-muted",children:s.email})]})]}),t&&e.jsxs("div",{className:"mt-24 flex w-max items-center gap-8 rounded-panel bg-danger-lighter px-10 py-6 text-sm text-danger-darker",children:[e.jsx(Te,{size:"sm"}),s.ban_reason?e.jsx(i,{message:"Suspended: :reason",values:{reason:s.ban_reason}}):e.jsx(i,{message:"Suspended"})]})]})}function Cs({user:s}){const[t,r]=x.useState(s.image??""),n=as(s.id);return e.jsx(is,{children:e.jsx(rs,{value:t,uploadType:we.avatars,variant:"avatar",stretchPreview:!0,previewSize:"w-90 h-90",placeholderIcon:e.jsx(Fe,{label:s.name,size:"w-full h-full text-2xl"}),onChange:(a,o)=>{n.mutate({image:o==null?void 0:o.url,image_entry_id:o==null?void 0:o.id},{onSuccess:()=>r((o==null?void 0:o.url)??"")})}})})}export{st as Component};
